<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Admin Panel - Reservations</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <nav>
        <a href="/">Home</a>
        <a href="/admin.html">Admin</a>
    </nav>

    <div class="container">
        <h1>Reservation Panel</h1>
        <input type="text" id="searchInput" placeholder="Search by name..." />

        <table id="reservationTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Full Name</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Date and Time</th>
                    <th>Reason</th>
                    <th>Category</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows dynamically inserted -->
            </tbody>
        </table>
    </div>

    <footer>
        <p>&copy; 2025 Reservation System</p>
    </footer>

    <!-- Modal de Edición -->
    <div id="editModal" class="modal hidden">
        <div class="modal-content">
            <h2>Edit Reservation</h2>
            <form id="editForm">
                <input type="hidden" id="editId" />
                <label for="editName">Full Name:</label>
                <input type="text" id="editName" required />

                <label for="editPhone">Phone number:</label>
                <input type="tel" id="editPhone" pattern="^\+?\d{7,15}$" required />

                <label for="editEmail">Email:</label>
                <input type="email" id="editEmail" required />

                <label for="editDate">Date and Time:</label>
                <input type="datetime-local" id="editDate" required />

                <label for="editReason">Reason / Comment:</label>
                <textarea id="editReason" rows="3"></textarea>

                <label for="editCategory">Category:</label>
                <select id="editCategory" required>
                    <option value="medical">Medical</option>
                    <option value="esthetic">Esthetic</option>
                    <option value="mechanic">Mechanic</option>
                    <option value="other">Other</option>
                </select>

                <div class="modal-buttons">
                    <button type="submit">Save</button>
                    <button type="button" id="cancelEdit">Cancel</button>
                </div>
            </form>

        </div>
    </div>

    <script>
        // Función para mostrar las reservaciones
        async function loadReservations() {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("Debes iniciar sesión como administrador para ver las reservaciones.");
                // Opcional: redirigir a login o home
                return;
            }

            try {
                // Verificar que el usuario es admin
                const meRes = await fetch("/api/me", {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (!meRes.ok) {
                    throw new Error("No autorizado. Por favor inicia sesión.");
                }

                const user = await meRes.json();
                if (user.role !== "admin") {
                    alert("No tienes permisos para acceder a esta página.");
                    // Opcional: redirigir a home
                    return;
                }

                // Obtener reservaciones
                const res = await fetch("/api/reservations", {
                    headers: { "Authorization": "Bearer " + token }
                });

                if (!res.ok) {
                    throw new Error("Error al obtener las reservaciones.");
                }

                const data = await res.json();

                const tableBody = document.querySelector("#reservationTable tbody");
                tableBody.innerHTML = ""; // limpiar tabla antes de insertar

                data.forEach(reservation => {
                    const row = document.createElement("tr");

                    row.innerHTML = `
                        <td>${reservation.id}</td>
                        <td>${reservation.name}</td>
                        <td>${reservation.phone}</td>
                        <td>${reservation.email}</td>
                        <td>${reservation.date}</td>
                        <td>${reservation.reason || ""}</td>
                        <td>${reservation.category}</td>
                        <td>
                            <button class="edit-btn" data-id="${reservation.id}" data-name="${reservation.name}" data-phone="${reservation.phone}" data-email="${reservation.email}" data-date="${reservation.date}" data-reason="${reservation.reason || ""}" data-category="${reservation.category}">Edit</button>
                            <button class="delete-btn" data-id="${reservation.id}">Delete</button>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });
            } catch (error) {
                alert(error.message);
                console.error(error);
            }
        }

        // Llamar a cargar las reservaciones al cargar la página
        loadReservations();

        // Manejo de búsqueda
        document.getElementById("searchInput").addEventListener("keyup", function () {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll("#reservationTable tbody tr");

            rows.forEach(row => {
                const nameCell = row.querySelectorAll("td")[1];
                if (nameCell) {
                    const name = nameCell.textContent.toLowerCase();
                    row.style.display = name.includes(filter) ? "" : "none";
                }
            });
        });

        // Manejo de botones eliminar
        document.addEventListener("click", async function (e) {
            if (e.target && e.target.classList.contains("delete-btn")) {
                const token = localStorage.getItem("token");
                if (!token) {
                    alert("Debes iniciar sesión para eliminar reservaciones.");
                    return;
                }

                const id = e.target.dataset.id;
                const confirmDelete = confirm("¿Seguro que quieres eliminar esta reservación?");
                if (!confirmDelete) return;

                try {
                    const res = await fetch(`/api/reservations/${id}`, {
                        method: "DELETE",
                        headers: { "Authorization": "Bearer " + token }
                    });

                    if (res.ok) {
                        e.target.closest("tr").remove();
                        alert("Reservación eliminada correctamente.");
                    } else {
                        alert("No se pudo eliminar la reservación.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Error al eliminar la reservación.");
                }
            }
        });

        // Manejo de botones editar (abrir modal)
        document.addEventListener("click", function (e) {
            if (e.target && e.target.classList.contains("edit-btn")) {
                const id = e.target.dataset.id;
                const name = e.target.dataset.name;
                const phone = e.target.dataset.phone;
                const email = e.target.dataset.email;
                const date = e.target.dataset.date;
                const reason = e.target.dataset.reason;
                const category = e.target.dataset.category;

                document.getElementById("editId").value = id;
                document.getElementById("editName").value = name;
                document.getElementById("editPhone").value = phone;
                document.getElementById("editEmail").value = email;
                document.getElementById("editDate").value = new Date(date).toISOString().slice(0, 16);
                document.getElementById("editReason").value = reason || "";
                document.getElementById("editCategory").value = category;

                document.getElementById("editModal").classList.remove("hidden");
            }
        });

        // Cancelar edición
        document.getElementById("cancelEdit").addEventListener("click", () => {
            document.getElementById("editModal").classList.add("hidden");
        });

        // Guardar cambios de edición
        document.getElementById("editForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const token = localStorage.getItem("token");
            if (!token) {
                alert("Debes iniciar sesión para editar reservaciones.");
                return;
            }

            const id = document.getElementById("editId").value;
            const newName = document.getElementById("editName").value.trim();
            const newPhone = document.getElementById("editPhone").value.trim();
            const newEmail = document.getElementById("editEmail").value.trim();
            const newDate = document.getElementById("editDate").value;
            const newReason = document.getElementById("editReason").value.trim();
            const newCategory = document.getElementById("editCategory").value;

            // Validaciones
            if (newName.length < 3) {
                alert("El nombre debe tener al menos 3 caracteres.");
                return;
            }

            const phoneRegex = /^\+?\d{7,15}$/;
            if (!phoneRegex.test(newPhone)) {
                alert("Por favor ingresa un número de teléfono válido.");
                return;
            }

            if (!newEmail.includes("@")) {
                alert("Por favor ingresa un correo válido.");
                return;
            }

            if (!newDate || isNaN(Date.parse(newDate))) {
                alert("Por favor ingresa una fecha y hora válidas.");
                return;
            }

            const selectedDate = new Date(newDate);
            const now = new Date();
            if (selectedDate <= now) {
                alert("La fecha debe ser futura.");
                return;
            }

            if (!newCategory) {
                alert("Selecciona una categoría.");
                return;
            }

            try {
                const res = await fetch(`/api/reservations/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({
                        name: newName,
                        phone: newPhone,
                        email: newEmail,
                        date: newDate,
                        reason: newReason,
                        category: newCategory
                    })
                });

                if (res.ok) {
                    const rows = document.querySelectorAll("#reservationTable tbody tr");
                    rows.forEach(row => {
                        if (row.children[0].textContent === id) {
                            row.children[1].textContent = newName;
                            row.children[2].textContent = newPhone;
                            row.children[3].textContent = newEmail;
                            row.children[4].textContent = newDate;
                            row.children[5].textContent = newReason;
                            row.children[6].textContent = newCategory;

                            const editBtn = row.querySelector(".edit-btn");
                            editBtn.dataset.name = newName;
                            editBtn.dataset.phone = newPhone;
                            editBtn.dataset.email = newEmail;
                            editBtn.dataset.date = newDate;
                            editBtn.dataset.reason = newReason;
                            editBtn.dataset.category = newCategory;
                        }
                    });

                    alert("Reservación actualizada correctamente.");
                    document.getElementById("editModal").classList.add("hidden");
                } else {
                    alert("No se pudo actualizar la reservación.");
                }
            } catch (err) {
                console.error(err);
                alert("Error al actualizar la reservación.");
            }
        });

    </script>
</body>
</html>
