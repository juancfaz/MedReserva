<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Reservations</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <a href="/">Home</a>
        <a href="/admin.html">Admin</a>
    </nav>

    <div class="container">
        <h1>Reservation Panel</h1>
        <input type="text" id="searchInput" placeholder="Search by name..." />

        <table id="reservationTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Full Name</th>
                    <th>Date and Time</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be inserted here -->
            </tbody>
        </table>
    </div>

    <footer>
        <p>&copy; 2025 Reservation System</p>
    </footer>

    <!-- Modal de Edición -->
    <div id="editModal" class="modal hidden">
    <div class="modal-content">
        <h2>Edit Reservation</h2>
        <form id="editForm">
        <input type="hidden" id="editId">
        <label for="editName">Full Name:</label>
        <input type="text" id="editName" required>
        <label for="editDate">Date and Time:</label>
        <input type="datetime-local" id="editDate" required>
        <div class="modal-buttons">
            <button type="submit">Save</button>
            <button type="button" id="cancelEdit">Cancel</button>
        </div>
        </form>
    </div>
    </div>


    <script>
        fetch("/api/reservations")
            .then(res => res.json())
            .then(data => {
                const tableBody = document.querySelector("#reservationTable tbody");

                data.forEach(reservation => {
                    const row = document.createElement("tr");

                    row.innerHTML = `
                        <td>${reservation.id}</td>
                        <td>${reservation.name}</td>
                        <td>${reservation.date}</td>
                        <td>
                            <button class="edit-btn" data-id="${reservation.id}" data-name="${reservation.name}" data-date="${reservation.date}">Edit</button>
                            <button class="delete-btn" data-id="${reservation.id}">Delete</button>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });
            });

        document.addEventListener("click", function (e) {
            if (e.target && e.target.classList.contains("delete-btn")) {
                const id = e.target.dataset.id;
                const confirmDelete = confirm("Are you sure you want to delete this reservation?");
                if (!confirmDelete) return;

                fetch(`/api/reservations/${id}`, {
                    method: "DELETE",
                })
                .then(res => {
                    if (res.ok) {
                        e.target.closest("tr").remove();
                        alert("Reservation deleted successfully.");
                    } else {
                        alert("Failed to delete the reservation.");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Error deleting reservation.");
                });
            }
        });

        document.getElementById("searchInput").addEventListener("keyup", function () {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll("#reservationTable tbody tr");

            rows.forEach(row => {
                const nameCell = row.querySelectorAll("td")[1]; // ← columna del nombre
                if (nameCell) {
                    const name = nameCell.textContent.toLowerCase();
                    row.style.display = name.includes(filter) ? "" : "none";
                }
            });
        });

        document.addEventListener("click", function (e) {
        if (e.target && e.target.classList.contains("edit-btn")) {
            const id = e.target.dataset.id;
            const name = e.target.dataset.name;
            const date = e.target.dataset.date;

            document.getElementById("editId").value = id;
            document.getElementById("editName").value = name;
            document.getElementById("editDate").value = new Date(date).toISOString().slice(0,16);

            document.getElementById("editModal").classList.remove("hidden");
        }
        });

        document.getElementById("cancelEdit").addEventListener("click", () => {
        document.getElementById("editModal").classList.add("hidden");
        });

        document.getElementById("editForm").addEventListener("submit", function (e) {
            e.preventDefault();

            const id = document.getElementById("editId").value;
            const newName = document.getElementById("editName").value.trim();
            const newDate = document.getElementById("editDate").value;

            if (newName.length < 3) {
                alert("Name must be at least 3 characters.");
                return;
            }

            if (!newDate || isNaN(Date.parse(newDate))) {
                alert("Please enter a valid date and time.");
                return;
            }

            const selectedDate = new Date(newDate);
            const now = new Date();
            if (selectedDate <= now) {
                alert("Date must be in the future.");
                return;
            }

            fetch(`/api/reservations/${id}`, {
                method: "PUT",
                headers: {
                "Content-Type": "application/json",
                },
                body: JSON.stringify({ name: newName, date: newDate }),
            })
                .then(res => {
                if (res.ok) {
                    // Actualizar fila en la tabla
                    const rows = document.querySelectorAll("#reservationTable tbody tr");
                    rows.forEach(row => {
                    if (row.children[0].textContent === id) {
                        row.children[1].textContent = newName;
                        row.children[2].textContent = newDate;
                        // También actualizar el data-* del botón Edit
                        const editBtn = row.querySelector(".edit-btn");
                        editBtn.dataset.name = newName;
                        editBtn.dataset.date = newDate;
                    }
                    });

                    alert("Reservation updated successfully.");
                    document.getElementById("editModal").classList.add("hidden");
                } else {
                    alert("Failed to update reservation.");
                }
                })
                .catch(err => {
                console.error(err);
                alert("Error updating reservation.");
                });
            });
    </script>

</body>
</html>
